var room1Walls = [1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 15, 5, 14, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 4, 0, 0, 11, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 12, 0, 0, 0, 6, 4, 0, 0, 14, 15, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 14, 15, 0, 0, 0, 6, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 15, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 14, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 4, 0, 0, 11, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 12, 0, 0, 6, 4, 0, 0, 14, 15, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 14, 15, 0, 0, 6, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 7, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 12, 5, 11, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 9];

var PIXI = require("pixi");
var Matter = require("matter");
var Keyboard = require("crtrdg-keyboard");

var room1Image = PIXI.Texture.fromImage("rooms/room1.png");
var playerImage = PIXI.Texture.fromImage("sprites/player.png")

var roomWidth = 27;
var roomHeight = 27;
var tileWidth = 27;
var tileHeight = 27;
var renderScale = 3;

var input = new Input();

var Engine = Matter.Engine,
    Events = Matter.Events,
    World = Matter.World,
    Bodies = Matter.Bodies,
    Body = Matter.Body;

var renderer;
var stage;
var gameView;
var engine;
var room1Sprite;
var playerSprite;
var player;

function startGame()
{
  document.getElementById("main").style.display = "none";

  renderer = PIXI.autoDetectRenderer(800,600, {backgroundColor : 0x000000});
  document.getElementById("menu").appendChild(renderer.view);
  stage = new PIXI.Container();

  gameView = new PIXI.Container();

  engine = Engine.create();
  engine.world.gravity.x = 0;
  engine.world.gravity.y = 0;

  room1Sprite = new PIXI.Sprite(room1Image);
  room1Sprite.texture.baseTexture.scaleMode = PIXI.SCALE_MODES.NEAREST;
  room1Sprite.position.x = 0;
  room1Sprite.position.y = 0;
  stage.addChild(room1Sprite);

  playerSprite = new PIXI.Sprite(playerImage)
  playerSprite.texture.baseTexture.scaleMode = PIXI.SCALE_MODES.NEAREST;
  stage.addChild(playerSprite);

  player = Bodies.circle(tileWidth*roomWidth/2, tileHeight*roomHeight/2, 27/2);
  player.friction = 1;
  player.walkSpeed = 80;
  player.slop = 0;

  player.attacking = false;
  player.attackTimer = 0;

  World.add(engine.world, player);

  createRoom(room1Walls);

  Events.on(engine, "beforeUpdate", beforeUpdate);
  draw();
  Engine.run(engine);
}

function createRoom(room)
{
  var boxes = [];
  for(i = 0 ; i < roomHeight ; i++)
  {
    for(j = 0 ; j < roomWidth ; j++)
    {
      var x = j * tileWidth;
      var y = i * tileHeight;
      var tileID = room[i*roomWidth + j] - 1;
      if(tileID != -1)
      {
        var box = Bodies.rectangle(x, y, tileWidth, tileHeight, {isStatic:true});
        boxes.push(box);
      }
    }
  }
  World.add(engine.world, boxes);
};

function Input()
{
  this.moveUp = false;
  this.moveDown = false;
  this.moveLeft = false;
  this.moveRight = false;

  this.attackUp = false;
  this.attackDown = false;
  this.attackLeft = false;
  this.attackRight = false;

  var input = this;

  this.onKeyDown = function(event)
  {
    switch(event.keyCode)
    {
      case 87: // W
        input.moveUp = true;
        break;
      case 83: // S
        input.moveDown = true;
        break;
      case 65: // A
        input.moveLeft = true;
        break;
      case 68: // D
        input.moveRight = true;
        break;

      case 73: // I
        input.attackUp = true;
        console.log(input);
        break;
      case 75: // K
        input.attackDown = true;
        break;
      case 74: // J
        input.attackLeft = true;
        break;
      case 76: // L
        input.attackRight = true;
        break;
    }
  };
  this.onKeyUp = function(event)
  {
    switch(event.keyCode)
    {
      case 87:
        input.moveUp = false;
        break;
      case 83:
        input.moveDown = false;
        break;
      case 65:
        input.moveLeft = false;
        break;
      case 68:
        input.moveRight = false;
        break

      case 73: // I
        input.attackUp = false;
        break;
      case 75: // K
        input.attackDown = false;
        break;
      case 74: // J
        input.attackLeft = false;
        break;
      case 76: // L
        input.attackRight = false;
        break;
    }
  };

  //document.addEventListener("keydown", this.onKeyDown, false);
  //document.addEventListener("keyup", this.onKeyUp, false);

  console.log("Input loaded.");
}

function beforeUpdate()
{
  var deltaTime = engine.timing.delta / 1000;

  player.attackTimer -= deltaTime;
  if(player.attackTimer < 0)
  {
    player.attackTimer = 0;
    if(player.attacking)
    {
      attacking = false;
    }
  }

  var walkForce = { x:0, y:0 };

  if(!player.attacking)
  {
    if(input.moveUp)
    {
      walkForce.y -= 1;
    }
    if(input.moveDown)
    {
      walkForce.y += 1;
    }
    if(input.moveLeft)
    {
      walkForce.x -= 1;
    }
    if(input.moveRight)
    {
      walkForce.x += 1;
    }

    if(input.attackUp)
    {
      attackTimer = 1;
      attacking = true;
    }
  }

  var magnitude = Math.sqrt(walkForce.x*walkForce.x + walkForce.y*walkForce.y);

  if(magnitude > 0)
  {
    walkForce.x *= deltaTime * player.walkSpeed / magnitude;
    walkForce.y *= deltaTime * player.walkSpeed / magnitude;

    var walkTo = {
      x : walkForce.x + player.position.x,
      y : walkForce.y + player.position.y
    };

    Body.translate(player, walkForce);
  }
  else
  {

  }
};

function draw()
{
  requestAnimationFrame(draw);

  playerSprite.position = player.position;

  stage.height = tileHeight*roomHeight*renderScale;
  stage.width = tileWidth*roomWidth*renderScale;
  stage.position.x = -renderScale * (player.position.x + 27/2) + renderer.width / 2;
  stage.position.y = -renderScale * (player.position.y + 27/2) + renderer.height / 2;

  renderer.render(stage);
}

document.addEventListener("DOMContentLoaded", function(event)
{
  document.getElementById("credits").style.display = "none";
  document.getElementById("startButton").onclick = startGame;
});
